@{
    ViewData["Title"] = "Two-Factor Authentication Settings";
    bool is2FAEnabled = ViewBag.Is2FAEnabled ?? false;
    int recoveryCodesLeft = ViewBag.RecoveryCodesLeft ?? 0;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt"></i> Two-Factor Authentication Settings
                    </h4>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle"></i> @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-mobile-alt fa-3x text-primary mb-3"></i>
                                    <h5>Two-Factor Authentication</h5>
                                    <p class="text-muted">
                                        Add an extra layer of security to your account with two-factor authentication.
                                    </p>

                                    <div class="mb-3">
                                        <span class="badge bg-@(is2FAEnabled ? "success" : "secondary") fs-6">
                                            <i class="fas fa-@(is2FAEnabled ? "check" : "times")"></i>
                                            @(is2FAEnabled ? "Enabled" : "Disabled")
                                        </span>
                                    </div>

                                    @if (is2FAEnabled)
                                    {
                                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#disable2FAModal">
                                            <i class="fas fa-times"></i> Disable 2FA
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#enable2FAModal">
                                            <i class="fas fa-shield-alt"></i> Enable 2FA
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>

                        @if (is2FAEnabled)
                        {
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-key fa-3x text-warning mb-3"></i>
                                        <h5>Recovery Codes</h5>
                                        <p class="text-muted">
                                            Keep your recovery codes safe. You can use them to access your account if you lose your device.
                                        </p>

                                        <div class="mb-3">
                                            <span class="badge bg-info fs-6">
                                                <i class="fas fa-info-circle"></i>
                                                @recoveryCodesLeft codes remaining
                                            </span>
                                        </div>

                                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#generateCodesModal">
                                            <i class="fas fa-sync"></i> Generate New Codes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="mt-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>How it works:</strong>
                            <ul class="mb-0 mt-2">
                                <li>When you enable 2FA, you'll receive a verification code via email each time you log in.</li>
                                <li>This code is valid for 5 minutes and can only be used once.</li>
                                <li>Keep your recovery codes safe - they can be used to access your account if needed.</li>
                                <li>You can disable 2FA at any time using your password.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="text-end mt-3">
                        <a href="@Url.Action("Profile", "VAuth")" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enable 2FA Modal -->
<div class="modal fade" id="enable2FAModal" tabindex="-1" aria-labelledby="enable2FAModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enable2FAModalLabel">
                    <i class="fas fa-shield-alt"></i> Enable Two-Factor Authentication
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Enable2FA" method="post">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Important:</strong> Once enabled, you'll need to enter a verification code sent to your email each time you log in.
                    </div>

                    <div class="mb-3">
                        <label for="enablePassword" class="form-label">Confirm your password:</label>
                        <input type="password" class="form-control" id="enablePassword" name="Password" required>
                        <div class="form-text">Enter your current password to enable 2FA.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shield-alt"></i> Enable 2FA
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Disable 2FA Modal -->
<div class="modal fade" id="disable2FAModal" tabindex="-1" aria-labelledby="disable2FAModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="disable2FAModalLabel">
                    <i class="fas fa-times"></i> Disable Two-Factor Authentication
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Disable2FA" method="post">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Disabling 2FA will make your account less secure.
                    </div>

                    <div class="mb-3">
                        <label for="disablePassword" class="form-label">Confirm your password:</label>
                        <input type="password" class="form-control" id="disablePassword" name="Password" required>
                        <div class="form-text">Enter your current password to disable 2FA.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i> Disable 2FA
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Generate Recovery Codes Modal -->
<div class="modal fade" id="generateCodesModal" tabindex="-1" aria-labelledby="generateCodesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateCodesModalLabel">
                    <i class="fas fa-sync"></i> Generate New Recovery Codes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will invalidate your old recovery codes.
                </div>

                <div class="mb-3">
                    <label for="generatePassword" class="form-label">Confirm your password:</label>
                    <input type="password" class="form-control" id="generatePassword" required>
                    <div class="form-text">Enter your current password to generate new recovery codes.</div>
                </div>

                <div id="newRecoveryCodes" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>New recovery codes generated!</strong> Save these codes in a safe place.
                    </div>
                    <div class="bg-light p-3 rounded">
                        <div id="recoveryCodesList"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="generateCodesBtn">
                    <i class="fas fa-sync"></i> Generate Codes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('generateCodesBtn').addEventListener('click', function() {
        const password = document.getElementById('generatePassword').value;

        if (!password) {
            alert('Please enter your password');
            return;
        }

        fetch('@Url.Action("GenerateRecoveryCodes", "VAuth")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(password)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const codesDiv = document.getElementById('recoveryCodesList');
                codesDiv.innerHTML = '';

                data.recoveryCodes.forEach(code => {
                    const codeElement = document.createElement('div');
                    codeElement.className = 'mb-1 font-monospace';
                    codeElement.textContent = code;
                    codesDiv.appendChild(codeElement);
                });

                document.getElementById('newRecoveryCodes').style.display = 'block';
                document.getElementById('generateCodesBtn').style.display = 'none';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating recovery codes');
        });
    });
</script>